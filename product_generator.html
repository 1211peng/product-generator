<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品資訊與文案生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 960px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        input[type="text"],
        input[type="number"],
        input[type="url"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            resize: vertical;
        }
        input:focus,
        textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4b5563;
        }
        button {
            background-color: #6366f1;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.3);
            width: 100%;
        }
        button:hover {
            background-color: #4f46e5;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        .secondary-button {
            background-color: #f0f4f8;
            color: #4b5563;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .secondary-button:hover {
            background-color: #e2e8f0;
        }
        .output-section {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-top: 2rem;
            border: 1px dashed #e5e7eb;
        }
        .output-section h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .output-item {
            margin-bottom: 1.5rem;
        }
        .output-item h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        .output-item pre {
            background-color: #e0e7ff;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 0.95rem;
            line-height: 1.6;
            color: #1e3a8a;
        }
        .price-display {
            font-size: 2rem;
            font-weight: 700;
            color: #10b981;
            text-align: center;
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #ecfdf5;
            border-radius: 0.75rem;
            border: 2px solid #34d399;
        }
        .price-display span {
            font-size: 1.2rem;
            color: #065f46;
        }
        .history-list {
            margin-top: 2rem;
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
        }
        .history-item {
            background-color: #ffffff;
            border: 1px solid #e0e7ff;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        .history-item-info {
            flex-grow: 1;
        }
        .history-item-info h5 {
            font-weight: 700;
            color: #374151;
            margin-bottom: 0.25rem;
        }
        .history-item-info p {
            font-size: 0.9rem;
            color: #6b7280;
        }
        .history-item-actions {
            display: flex;
            gap: 0.5rem;
        }
        .history-item-actions button {
            width: auto;
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            border-radius: 0.5rem;
            box-shadow: none;
        }
        .history-item-actions .view-button {
            background-color: #4f46e5;
        }
        .history-item-actions .view-button:hover {
            background-color: #4338ca;
        }
        .history-item-actions .delete-button {
            background-color: #ef4444;
        }
        .history-item-actions .delete-button:hover {
            background-color: #dc2626;
        }
        .search-input {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-3xl font-bold text-center mb-8 text-gray-800">商品資訊與文案生成器</h2>

        <div class="input-section mb-8">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">商品資訊貼上區</h3>
            <label for="fullProductInfoInput">請將所有商品資訊貼到這裡 (包含品名、連結、款式、備註、成本等):</label>
            <textarea id="fullProductInfoInput" rows="10" placeholder="例如：
跨境汽车金属一键启动摇杆球车载一键启动装饰贴汽车按钮键保护盖
https://detail.1688.com/offer/947903075253.html?offerId=947903075253
顏色：紅、黑、藍
一組2入
成本10/運15/集30"></textarea>

            <button onclick="generateProductInfo()">生成商品資訊與售價</button>
        </div>

        <div class="output-section" id="outputSection">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">生成結果</h3>

            <div class="output-item">
                <h4>優化後品名 (繁體)</h4>
                <pre id="optimizedProductName"></pre>
            </div>

            <div class="output-item">
                <h4>IG Reel 文案</h4>
                <pre id="igReelContent"></pre>
            </div>

            <div class="output-item">
                <h4>Threads 文案</h4>
                <pre id="threadsContent"></pre>
            </div>

            <div class="output-item">
                <h4>官網文案</h4>
                <pre id="officialWebsiteContent"></pre>
            </div>

            <div class="output-item">
                <h4>IG POV 文案</h4>
                <pre id="igPovContent"></pre>
            </div>

            <div class="price-display">
                建議售價: <span id="suggestedPrice"></span>
            </div>
        </div>

        <div class="history-list">
            <h3 class="text-2xl font-bold mb-4 text-gray-700">歷史紀錄</h3>
            <input type="text" id="searchHistory" class="search-input" placeholder="搜尋歷史紀錄...">
            <button onclick="exportToCsv()" class="secondary-button mb-4">匯出為 CSV (Excel)</button>
            <div id="productHistoryList">
                <!-- 歷史商品列表將在這裡顯示 -->
                <p class="text-gray-500 text-center" id="noHistoryMessage">目前沒有歷史紀錄。</p>
            </div>
        </div>
    </div>

    <script>
        // DOM 元素引用
        const fullProductInfoInput = document.getElementById('fullProductInfoInput');

        const optimizedProductNameOutput = document.getElementById('optimizedProductName');
        const igReelContentOutput = document.getElementById('igReelContent');
        const threadsContentOutput = document.getElementById('threadsContent');
        const officialWebsiteContentOutput = document.getElementById('officialWebsiteContent');
        const igPovContentOutput = document.getElementById('igPovContent');
        const suggestedPriceOutput = document.getElementById('suggestedPrice');

        const productHistoryListDiv = document.getElementById('productHistoryList');
        const searchHistoryInput = document.getElementById('searchHistory');
        const noHistoryMessage = document.getElementById('noHistoryMessage');

        const localStorageKey = 'productGeneratorHistoryV2'; // localStorage 的鍵值，儲存所有歷史紀錄

        // --- 輔助函數：簡體轉繁體 (簡化版，針對特定詞彙) ---
        function convertToTraditional(text) {
            let convertedText = text;
            // 寶可夢相關
            convertedText = convertedText.replace(/宝可梦/g, '寶可夢');
            convertedText = convertedText.replace(/Gengar/g, '耿鬼');
            convertedText = convertedText.replace(/耀西/g, '耀西');
            convertedText = convertedText.replace(/连体睡衣/g, '連體睡衣');
            convertedText = convertedText.replace(/情侣/g, '情侶');
            convertedText = convertedText.replace(/亲子/g, '親子');
            convertedText = convertedText.replace(/家居服/g, '家居服');
            convertedText = convertedText.replace(/甲贺忍蛙/g, '甲賀忍蛙');
            convertedText = convertedText.replace(/路卡利欧/g, '路卡利歐');
            convertedText = convertedText.replace(/超梦/g, '超夢');
            convertedText = convertedText.replace(/呆火鳄/g, '呆火鱷');
            convertedText = convertedText.replace(/伊布/g, '伊布');

            // 汽車相關
            convertedText = convertedText.replace(/汽车/g, '汽車');
            convertedText = convertedText.replace(/金属/g, '金屬');
            convertedText = convertedText.replace(/一键启动/g, '一鍵啟動');
            convertedText = convertedText.replace(/摇杆球/g, '搖桿球');
            convertedText = convertedText.replace(/车载/g, '車載');
            convertedText = convertedText.replace(/装饰贴/g, '裝飾貼');
            convertedText = convertedText.replace(/按钮键/g, '按鈕鍵');
            convertedText = convertedText.replace(/保护盖/g, '保護蓋');

            // 其他常見簡體字
            convertedText = convertedText.replace(/跨境/g, '跨境');
            convertedText = convertedText.replace(/颜色/g, '顏色');
            convertedText = convertedText.replace(/红色/g, '紅色');
            convertedText = convertedText.replace(/黑色/g, '黑色');
            convertedText = convertedText.replace(/蓝色/g, '藍色');
            convertedText = convertedText.replace(/组/g, '組');
            convertedText = convertedText.replace(/入/g, '入');
            convertedText = convertedText.replace(/内文/g, '內文');
            convertedText = convertedText.replace(/备注/g, '備註');
            convertedText = convertedText.replace(/成本/g, '成本');
            convertedText = convertedText.replace(/运/g, '運');
            convertedText = convertedText.replace(/集/g, '集');
            convertedText = convertedText.replace(/链接/g, '連結');


            return convertedText;
        }

        // --- 儲存所有歷史資料到 localStorage ---
        function saveProductHistory(history) {
            try {
                localStorage.setItem(localStorageKey, JSON.stringify(history));
                console.log('商品歷史資料已儲存到 localStorage。');
            } catch (e) {
                console.error('儲存到 localStorage 失敗:', e);
                alert('儲存歷史紀錄失敗，可能是瀏覽器儲存空間不足或隱私設定限制。');
            }
        }

        // --- 從 localStorage 載入所有歷史資料 ---
        function loadProductHistory() {
            try {
                const savedData = localStorage.getItem(localStorageKey);
                return savedData ? JSON.parse(savedData) : [];
            } catch (e) {
                console.error('從 localStorage 載入失敗:', e);
                alert('載入歷史紀錄失敗，可能是儲存的資料損壞。');
                return [];
            }
        }

        // --- 顯示歷史紀錄列表 ---
        function displayProductHistory(filterText = '') {
            const history = loadProductHistory();
            productHistoryListDiv.innerHTML = ''; // 清空現有列表

            if (history.length === 0) {
                noHistoryMessage.style.display = 'block';
                return;
            } else {
                noHistoryMessage.style.display = 'none';
            }

            const filteredHistory = history.filter(item => {
                const searchLower = filterText.toLowerCase();
                return item.optimizedProductName.toLowerCase().includes(searchLower) ||
                       item.originalProductName.toLowerCase().includes(searchLower) ||
                       item.igReelContent.toLowerCase().includes(searchLower) ||
                       item.threadsContent.toLowerCase().includes(searchLower) ||
                       item.officialWebsiteContent.toLowerCase().includes(searchLower) ||
                       item.igPovContent.toLowerCase().includes(searchLower);
            });

            if (filteredHistory.length === 0 && filterText !== '') {
                productHistoryListDiv.innerHTML = '<p class="text-gray-500 text-center">沒有找到符合條件的歷史紀錄。</p>';
                return;
            }

            // 倒序顯示，最新在最上面
            filteredHistory.slice().reverse().forEach((item, index) => {
                const historyItemDiv = document.createElement('div');
                historyItemDiv.className = 'history-item';
                historyItemDiv.innerHTML = `
                    <div class="history-item-info">
                        <h5>${item.optimizedProductName}</h5>
                        <p>建議售價: $${item.suggestedPrice}</p>
                        <p>原始品名: ${item.originalProductName.substring(0, 50)}...</p>
                        <p>生成時間: ${item.timestamp}</p>
                    </div>
                    <div class="history-item-actions">
                        <button class="view-button" onclick="loadProductToForm(${item.id})">查看/編輯</button>
                        <button class="delete-button" onclick="deleteProductFromHistory(${item.id})">刪除</button>
                    </div>
                `;
                productHistoryListDiv.appendChild(historyItemDiv);
            });
        }

        // --- 將歷史商品資料載入到表單和輸出區 ---
        function loadProductToForm(id) {
            const history = loadProductHistory();
            const product = history.find(item => item.id === id);

            if (product) {
                // 重建單一輸入欄位的內容
                let fullInfo = product.originalProductName + '\n';
                if (product.productUrl) fullInfo += product.productUrl + '\n';
                if (product.styles) fullInfo += `顏色/款式：${product.styles}\n`;
                if (product.sizes) fullInfo += `尺寸：${product.sizes}\n`;
                if (product.internalNotes) fullInfo += `備註：${product.internalNotes}\n`;
                fullInfo += `成本${product.cost}/運${product.shipping}/集${product.collectionFee}\n`;
                fullProductInfoInput.value = fullInfo.trim();

                // 同時更新輸出區域
                optimizedProductNameOutput.textContent = product.optimizedProductName;
                igReelContentOutput.textContent = product.igReelContent;
                threadsContentOutput.textContent = product.threadsContent;
                officialWebsiteContentOutput.textContent = product.officialWebsiteContent;
                igPovContentOutput.textContent = product.igPovContent;
                suggestedPriceOutput.textContent = `$${product.suggestedPrice}`;
            }
        }

        // --- 從歷史紀錄中刪除商品 ---
        function deleteProductFromHistory(id) {
            let history = loadProductHistory();
            const originalLength = history.length;
            history = history.filter(item => item.id !== id);

            if (history.length < originalLength) {
                saveProductHistory(history);
                displayProductHistory(searchHistoryInput.value); // 重新顯示列表
                // 如果刪除的是當前顯示在表單中的項目，清空表單
                if (fullProductInfoInput.value.includes(history.find(item => item.id === id)?.originalProductName || '')) {
                    clearFormAndOutput();
                }
            }
        }

        // --- 清空表單和輸出區 ---
        function clearFormAndOutput() {
            fullProductInfoInput.value = '';

            optimizedProductNameOutput.textContent = '';
            igReelContentOutput.textContent = '';
            threadsContentOutput.textContent = '';
            officialWebsiteContentOutput.textContent = '';
            igPovContentOutput.textContent = '';
            suggestedPriceOutput.textContent = '';
        }

        // --- 解析單一輸入欄位的資訊 ---
        function parseProductInfo(fullText) {
            const lines = fullText.split('\n').map(line => line.trim()).filter(line => line !== '');
            let originalName = '';
            let productUrl = '';
            let styles = '';
            let sizes = '';
            let internalNotes = '';
            let cost = 0;
            let shipping = 0;
            let collectionFee = 0;

            // 嘗試從第一行獲取原始品名，除非它看起來像URL或成本
            if (lines.length > 0 && !lines[0].match(/https?:\/\/\S+/i) && !lines[0].match(/成本\d+\/運\d+\/集\d+/)) {
                originalName = lines[0];
            } else if (lines.length > 1 && !lines[1].match(/https?:\/\/\S+/i) && !lines[1].match(/成本\d+\/運\d+\/集\d+/)) {
                // 如果第一行是URL或成本，嘗試第二行
                originalName = lines[0]; // 還是取第一行作為品名
            }


            fullText.split('\n').forEach(line => {
                line = line.trim();
                // 連結
                const urlMatch = line.match(/(https?:\/\/\S+)/i);
                if (urlMatch) {
                    productUrl = urlMatch[1];
                }
                // 款式/顏色
                const stylesMatch = line.match(/(顏色|款式)[:：]?\s*([^ \n]+(?:[、,，\/][^ \n]+)*)/);
                if (stylesMatch) {
                    styles = stylesMatch[2];
                }
                // 尺寸
                const sizesMatch = line.match(/(尺寸)[:：]?\s*([^\n]+)/);
                if (sizesMatch) {
                    sizes = sizesMatch[2];
                }
                // 內文備註 (包含 "一組2入" 等)
                const notesMatch = line.match(/(內文備註|備註|一組)[:：]?\s*([^\n]+)/);
                if (notesMatch) {
                    internalNotes = notesMatch[2];
                }
                // 成本
                const costMatch = line.match(/成本(\d+)\/運(\d+)\/集(\d+)/);
                if (costMatch) {
                    cost = parseFloat(costMatch[1]);
                    shipping = parseFloat(costMatch[2]);
                    collectionFee = parseFloat(costMatch[3]);
                }
            });

            // 如果原始品名沒有被明確解析出來，嘗試從第一行獲取
            if (!originalName && lines.length > 0) {
                originalName = lines[0].replace(productUrl, '').trim(); // 移除URL
            }
            // 如果原始品名仍然包含太多資訊，嘗試簡化
            if (originalName.length > 100) { // 假設過長的可能是多餘資訊
                const firstSentenceMatch = originalName.match(/^[^.!?。？！\n]+/);
                originalName = firstSentenceMatch ? firstSentenceMatch[0] : originalName.substring(0, 50) + '...';
            }


            return { originalName, productUrl, styles, sizes, internalNotes, cost, shipping, collectionFee };
        }

        // --- 生成商品資訊與售價 ---
        function generateProductInfo() {
            const fullText = fullProductInfoInput.value;
            if (!fullText.trim()) {
                alert('請在輸入框中貼上商品資訊！');
                return;
            }

            const { originalName, productUrl, styles, sizes, internalNotes, cost, shipping, collectionFee } = parseProductInfo(fullText);

            if (!originalName || cost === 0) {
                alert('無法從提供的資訊中解析出有效的商品品名或成本，請檢查格式！');
                return;
            }

            // 1. 優化品名 (簡體轉繁體並簡短)
            let optimizedName = convertToTraditional(originalName);
            // 移除常見的冗餘詞彙，並簡化
            optimizedName = optimizedName
                .replace(/跨境|汽車|金屬|一鍵啟動|搖桿球|車載|裝飾貼|按鈕鍵|保護蓋/g, (match) => {
                    switch(match) {
                        case '汽車': return ''; // 移除
                        case '金屬': return ''; // 移除
                        case '裝飾貼': return ''; // 移除
                        case '按鈕鍵': return ''; // 移除
                        case '保護蓋': return '保護蓋'; // 保留
                        case '一鍵啟動': return '一鍵啟動'; // 保留
                        case '搖桿球': return '搖桿球'; // 保留
                        default: return match;
                    }
                })
                .replace(/連體睡衣/g, '連體睡衣') // 確保轉換後簡短
                .replace(/寶可夢\s*連體睡衣/g, '寶可夢連體睡衣') // 避免重複
                .replace(/一鍵啟動搖桿球保護蓋/g, '一鍵啟動搖桿球保護蓋') // 確保完整品名
                .trim();

            // 如果優化後太短或不包含關鍵字，則使用預設或更完整的名稱
            if (optimizedName.length < 5 || (!optimizedName.includes('保護蓋') && !optimizedName.includes('睡衣') && !optimizedName.includes('連體衣'))) {
                 if (originalName.includes('宝可梦') || originalName.includes('Pokemon') || originalName.includes('寶可夢')) {
                    optimizedName = '寶可夢系列連體睡衣';
                } else if (originalName.includes('汽车') || originalName.includes('汽車') || originalName.includes('一键启动') || originalName.includes('一鍵啟動')) {
                    optimizedName = '汽車一鍵啟動搖桿球保護蓋';
                } else {
                    optimizedName = convertToTraditional(originalName).split(' ')[0] + '...'; // 取第一個詞
                }
            }
            optimizedProductNameOutput.textContent = optimizedName;

            // 2. 生成文案
            const stylesArr = styles.split(/[、,，\/]/).map(s => s.trim()).filter(s => s !== '');
            const stylesText = stylesArr.length > 0 ? stylesArr.join('、') : '多種款式/顏色';
            const hasPokemon = originalName.includes('宝可梦') || originalName.includes('Pokemon') || originalName.includes('寶可夢') || optimizedName.includes('寶可夢');
            const hasCar = originalName.includes('汽車') || originalName.includes('一鍵啟動') || optimizedName.includes('汽車');

            let igReel = '';
            let threads = '';
            let officialWebsite = '';
            let igPov = '';

            if (hasPokemon) {
                igReel = `
穿上牠們，一起進入寶可夢世界吧⚡️！

#${optimizedName}

想跟寶可夢一起宅家耍廢？這款連體睡衣真的太可以！
${stylesText.includes('呆火鱷') ? '呆火鱷超可愛、' : ''}${stylesText.includes('甲賀忍蛙') ? '甲賀忍蛙超帥，' : ''}還有${stylesText}等經典角色💥
連帽造型＋鬆軟材質，睡覺、追劇、打電動都舒服到不想脫～

尺寸：${sizes || 'S～XL'}，情侶閨蜜也能一起穿！${internalNotes ? `\n備註：${internalNotes}` : ''}

留言「寶可夢」我傳給你🧡
⚠️先追蹤再留言，才收得到喔！

台灣出貨🚚台灣官網下單，多種付款方式
全球配送🌍海外下單，截圖商品，私訊下單
                `.trim();

                threads = `
變身最可愛的牠！✨
${stylesText}等角色任你選💕
                `.trim();

                officialWebsite = `
**${optimizedName}**
尺寸：${sizes || 'S～XL'}，情侶閨蜜也能一起穿

想跟寶可夢一起宅家耍廢？
這款連體睡衣真的太可以！
${stylesText.includes('呆火鱷') ? '呆火鱷超可愛、' : ''}${stylesText.includes('甲賀忍蛙') ? '甲賀忍蛙超帥，' : ''}還有${stylesText}等經典角色💥
連帽造型＋鬆軟材質，睡覺、追劇、打電動都舒服到不想脫～
                `.trim();

                const randomPokemonStyle = stylesArr[Math.floor(Math.random() * stylesArr.length)] || '寶可夢';
                igPov = `
POV.別吵我，我今天是${randomPokemonStyle}不是上班族🐸🌀
                `.trim();

            } else if (hasCar) {
                igReel = `
一鍵啟動你的風格！✨

#${optimizedName}

想讓愛車內裝更吸睛？這款金屬搖桿球保護蓋絕對是你的菜！
${stylesText}可選，輕鬆點綴，讓你的車內空間瞬間升級💥
安裝簡單，手感舒適，不僅保護按鈕，更是個性展現！

${internalNotes ? `${internalNotes}，` : ''}情侶車、姐妹車都能一起用！

留言「搖桿球」我傳給你🧡
⚠️先追蹤再留言，才收得到喔！

台灣出貨🚚台灣官網下單，多種付款方式
全球配送🌍海外下單，截圖商品，私訊下單
                `.trim();

                threads = `
車內質感秒升級！✨
${stylesText}，一鍵啟動你的專屬風格💕
                `.trim();

                officialWebsite = `
**${optimizedName}**
${internalNotes}

想讓愛車內裝更吸睛？
這款金屬搖桿球保護蓋絕對是你的菜！
${stylesText}可選，輕鬆點綴，讓你的車內空間瞬間升級💥
安裝簡單，手感舒適，不僅保護按鈕，更是個性展現！
                `.trim();

                const randomCarStyle = stylesArr[Math.floor(Math.random() * stylesArr.length)] || '紅';
                igPov = `
POV.別吵我，我的車今天很${randomCarStyle.replace('色', '')}不是只有你😎${randomCarStyle === '紅' ? '🔴' : randomCarStyle === '黑' ? '⚫' : randomCarStyle === '藍' ? '🔵' : '✨'}
                `.trim();
            } else {
                // 泛用型文案
                igReel = `
全新商品登場！✨

#${optimizedName}

這款商品設計獨特，功能實用，絕對是您不可錯過的選擇！
${stylesText}多種選擇，滿足您的不同需求💥
高品質材料，精緻工藝，讓您的生活更美好～

尺寸：${sizes || '多種尺寸'} ${internalNotes ? `\n備註：${internalNotes}` : ''}

立即點擊連結了解更多！🔗

台灣出貨🚚台灣官網下單，多種付款方式
全球配送🌍海外下單，截圖商品，私訊下單
                `.trim();

                threads = `
超實用新品！✨
${stylesText}，讓生活更便利💕
                `.trim();

                officialWebsite = `
**${optimizedName}**
尺寸：${sizes || '多種尺寸'} ${internalNotes}

這款商品設計獨特，功能實用，絕對是您不可錯過的選擇！
${stylesText}多種選擇，滿足您的不同需求💥
高品質材料，精緻工藝，讓您的生活更美好～
                `.trim();

                igPov = `
POV.當我擁有${optimizedName}，生活品質直接提升一個檔次！✨
                `.trim();
            }

            igReelContentOutput.textContent = igReel;
            threadsContentOutput.textContent = threads;
            officialWebsiteContentOutput.textContent = officialWebsite;
            igPovContentOutput.textContent = igPov;


            // 3. 計算售價
            const initialCost = cost + shipping + collectionFee;
            const websiteFeeRate = 0.05; // 官網抽成 5%
            const creditCardFeeRate = 0.045; // 信用卡費率 4.5%
            const totalFeeRate = websiteFeeRate + creditCardFeeRate; // 總手續費率 9.5%
            const targetProfitMargin = 0.60; // 目標利潤 60%

            // 計算公式：售價 S = 初始成本 / (1 - 總手續費率 - 目標利潤率)
            let suggestedPrice = initialCost / (1 - totalFeeRate - targetProfitMargin);

            // 確保價格為整數，並向上取整
            suggestedPrice = Math.ceil(suggestedPrice);
            suggestedPriceOutput.textContent = `$${suggestedPrice}`;

            // --- 將本次生成的資料加入歷史紀錄 ---
            const newProductEntry = {
                id: Date.now(), // 使用時間戳作為唯一ID
                timestamp: new Date().toLocaleString('zh-TW', { hour12: false }), // 記錄生成時間
                originalProductName: originalName,
                styles: styles, // 儲存原始解析的 styles 字串
                sizes: sizes,
                internalNotes: internalNotes,
                cost: cost,
                shipping: shipping,
                collectionFee: collectionFee,
                productUrl: productUrl,
                optimizedProductName: optimizedName,
                igReelContent: igReel,
                threadsContent: threads,
                officialWebsiteContent: officialWebsite,
                igPovContent: igPov,
                suggestedPrice: suggestedPrice
            };

            const history = loadProductHistory();
            history.push(newProductEntry);
            saveProductHistory(history);
            displayProductHistory(searchHistoryInput.value); // 更新歷史列表
        }

        // --- 匯出為 CSV (Excel) ---
        function exportToCsv() {
            const history = loadProductHistory();
            if (history.length === 0) {
                alert('沒有歷史紀錄可以匯出！');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // 添加 BOM 以確保中文顯示正常

            // CSV 表頭
            const headers = [
                'ID', '生成時間', '原始品名', '優化後品名', '款式', '尺寸', '內文備註',
                '成本', '運費', '集運費', '商品連結', '建議售價',
                'IG Reel 文案', 'Threads 文案', '官網文案', 'IG POV 文案'
            ];
            csvContent += headers.map(h => `"${h}"`).join(',') + '\n';

            // CSV 內容
            history.forEach(item => {
                const row = [
                    item.id,
                    item.timestamp,
                    item.originalProductName,
                    item.optimizedProductName,
                    item.styles, // 使用儲存的 styles 字串
                    item.sizes,
                    item.internalNotes,
                    item.cost,
                    item.shipping,
                    item.collectionFee,
                    item.productUrl,
                    item.suggestedPrice,
                    `"${item.igReelContent.replace(/"/g, '""')}"`, // 處理引號
                    `"${item.threadsContent.replace(/"/g, '""')}"`,
                    `"${item.officialWebsiteContent.replace(/"/g, '""')}"`,
                    `"${item.igPovContent.replace(/"/g, '""')}"`
                ];
                csvContent += row.map(field => {
                    // 對於包含逗號、引號或換行的字串進行處理
                    if (typeof field === 'string' && (field.includes(',') || field.includes('"') || field.includes('\n'))) {
                        return `"${field.replace(/"/g, '""')}"`;
                    }
                    return field;
                }).join(',') + '\n';
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', '商品生成歷史紀錄.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- 頁面載入時自動載入資料並顯示歷史紀錄 ---
        window.onload = () => {
            const history = loadProductHistory();
            if (history.length > 0) {
                // 載入最新一筆資料到輸入框和輸出區
                const latestProduct = history[history.length - 1];
                loadProductToForm(latestProduct.id);
            } else {
                // 如果沒有歷史紀錄，則填入你提供的汽車商品範例
                fullProductInfoInput.value = `跨境汽车金属一键启动摇杆球车载一键启动装饰贴汽车按钮键保护盖
https://detail.1688.com/offer/947903075253.html?offerId=947903075253
顏色：紅、黑、藍
一組2入
成本10/運15/集30`;
                generateProductInfo(); // 自動生成一次，以便在初次載入時顯示內容
            }
            displayProductHistory(); // 顯示所有歷史紀錄
        };

        // --- 搜尋功能監聽 ---
        searchHistoryInput.addEventListener('input', (event) => {
            displayProductHistory(event.target.value);
        });
    </script>
</body>
</html>
